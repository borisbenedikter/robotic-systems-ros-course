## Build your own ROS 2 Packages

In this section, we will see how to create and build a ROS 2 workspace with `colcon`, the ROS 2 build tool.
`colcon` is a command-line tool that facilitates the task of building a set of software packages with a single command.
In ROS 1, multiple different tools were used, namely `catkin_make`, `catkin_make_isolated`, and `catkin_tools`.
`colcon` is a unified build tool that replaces all of these tools.

### Install `colcon`

It may be already installed in your system, as it comes with the ROS 2 installation.
To install `colcon`, you can use the following command in Linux:

```bash
sudo apt install python3-colcon-common-extensions
```

### Workspace File Structure

A ROS 2 workspace is a directory with a particular structure:

```bash
workspace_name/
└── src
└── build
└── install
└── log
```

- `src`: This directory contains the source code of the ROS 2 packages.
- `build`: This directory contains the intermediate files generated during the build process.
- `install`: This directory is where the built packages are installed. Each package is installed in its own subdirectory.
- `log`: This directory contains the log files generated during the `colcon` invocation.

### Create a ROS 2 Workspace

To create a ROS 2 workspace, you simply have to create a directory, populate it with the source files, and build the packages.

For instance, to create a ROS 2 workspace called `ros2_ws`, you would run the following commands:

```bash
mkdir -p <path/to>/ros2_ws/src
cd <path/to>/ros2_ws
```

where `<path/to>` is the path to the directory where you want to create the workspace.
The command `mkdir -p` creates the `ros2_ws` directory and the `src` subdirectory. Indeed, the flag `-p` creates the parent directories if they do not exist.
The resulting directory structure will be:

```bash
ros2_ws/
└── src
```

### Build the ROS 2 Workspace

To build the ROS 2 workspace, move to the root directory of the workspace and run the following command:

```bash
cd <path/to>/ros2_ws
colcon build --symlink-install
```

The `--symlink-install` flag is optional and saves you from having to rebuild every time you tweak python scripts.

After running the `colcon build` command, you will see the folders `build`, `install`, and `log` in the workspace directory.

To check the built packages, you can use the following command:

```bash
colcon test
```

### Source the ROS 2 Workspace

To use the packages built in the ROS 2 workspace, you need to add it to your path and library paths.
This can be done by using the bash files generated by `colcon` in the `install` directory.
These files will add all of the required elements to your path and library paths as well as provide any bash commands exported by packages.
In Linux, you can source the workspace by running the following command:

```bash
source <path/to>/ros2_ws/install/setup.bash
```

### Resolving Workspace Dependencies

Before building the workspace, you may or may not need to install additional dependencies.
Best practice is to check for dependencies every time you download a new package.

To resolve the dependencies of a workspace, you would run the following command:

```bash
cd <path/to>/ros2_ws
rosdep install -i --from-path src --rosdistro iron -y
```

Note that the `rosdep` command must be run from the root directory of the workspace.
The flag `-i` ignores any packages that are already installed, the flag `--from-path` specifies the path to the source directory of the packages whose dependencies need to be resolved, the flag `--rosdistro` specifies the ROS distribution, and the flag `-y` installs the dependencies without asking for confirmation.

The first time you run the `rosdep` command, the system may ask you to initialize and update the `rosdep` database.
To do this, you would need to run the following commands:

```bash
sudo rosdep init
rosdep update
```

If all the dependencies were already installed, the `rosdep` command will output the following message:

```bash
#All required rosdeps installed successfully
```

To check if all the necessary dependencies were installed, you can try to build the workspace with `colcon`:

```bash
colcon build --symlink-install
```

The build may fail if some python packages are missing.
A common error message is:

```bash
ModuleNotFoundError: No module named 'package_name'
```

In this case, you can install the missing packages using `conda` or `pip`.

After installing the missing packages, you can try to build the workspace again with `colcon`.
If the build is successful, you can source the workspace to install the executables in your path:

```bash
source <path/to>/ros2_ws/install/setup.bash
```

### Create a New ROS 2 Package

To create a new ROS 2 package, you must move to the `src` directory of the workspace and use the `ros2 pkg create` command:

```bash
cd <path/to>/<ws>/src
ros2 pkg create --build-type ament_python --license Apache-2.0 --node-name <hello_world_node> <package_name>
```

The `--build-type` flag specifies the build type of the package, which can be `ament_cmake` or `ament_python`, depending on whether the package is written in C++ or Python, respectively.
The `--license` flag specifies the license of the package, which can be `Apache-2.0`, `BSD`, `GPL-2.0`, etc.
The `--node-name` flag creates a simple Hello World executable node in the package.

For instance, to create a new ROS 2 package called `my_package` with a Python node named `my_node`, you would run the following command:

```bash
cd <path/to>/ros2_ws/src
ros2 pkg create --build-type ament_python --license Apache-2.0 --node-name my_node my_package
```

After running the command, the following directory structure will be created:

```bash
ros2_ws/
└── src
    └── my_package
        ├── my_package      # Python package
            └── __init__.py     # Marker file
            └── my_node.py      # Python src code
        ├── resource         
            └── my_package      # ROS 2 marker file
        ├── test
            └── test_copyright.py
            └── test_flake8.py
            └── test_pep257.py
        ├── LICENSE         # License file
        ├── package.xml     # Package metadata
        ├── setup.cfg       # Package executable configuration
        └── setup.py        # Package installation script
```

The `my_package` directory contains the source code of the package.
Specifically, the `my_node.py` file contains the Python code of the `my_node` executable node, which prints `Hi from my_package` to the console.
The `resource` directory contains the marker file `my_package`, which is used to identify the package.
The `package.xml` file contains the metadata of the package, such as the package name, version, description, dependencies, etc.
The `setup.cfg` is required when the package has executable nodes, so `ros2 run` can find them.
The `setup.py` file contains the instructions for installing the package.

Once the package is created, you can build the workspace with `colcon`:

```bash
cd <path/to>/ros2_ws
colcon build --symlink-install --packages-select my_package
```

The flag `--packages-select my_package` specifies that only the `my_package` package should be built.

After building the workspace, you can source it and run the `my_node` executable node:

```bash
source <path/to>/ros2_ws/install/setup.bash
ros2 run my_package my_node
```

If the node is running correctly, you will see the message `Hi from my_package` printed to the console.

### Customizing the Package

You can customize the package by modifying the files in the `my_package` directory.
For instance, you can modify the `package.xml` file to include your name as the author of the package, the description of the package, etc.

The `setup.py` file contains the same metadata as the `package.xml` file.
Thus, you would have to modify the `setup.py` file to include the same information as the `package.xml` file.

### Publisher-Subscriber Example

Let's create a simple publisher-subscriber example in ROS 2.
To create a simple publisher-subscriber example, we will create a new package called `pub_sub` with a Python publisher node and a Python subscriber node.

#### Create a New Workspace

Let's start by creating a new ROS 2 workspace called `pub_sub_ws`.
To create a new ROS 2 workspace, you need simply to create a directory with the `src` subdirectory.

#### Create the Package

Once the `pub_sub_ws/src` directory is created, you need to populate it with packages.
In this case, we will create only one package called `pub_sub`.
So, let's create the `pub_sub` package with the following command:

```bash
cd <path/to>/pub_sub_ws/src
ros2 pkg create --build-type ament_python --license Apache-2.0 --node-name pub_sub_hello_world pub_sub
```

The `pkg create` command creates a simple Hello World executable node in the package.

Once the package is created, you can build the workspace with `colcon` from the root directory of the workspace:

```bash
cd <path/to>/pub_sub_ws
colcon build --symlink-install
```

After building the workspace, you can source it and run the `pub_sub_hello_world` executable node:

```bash
source <path/to>/pub_sub_ws/install/setup.bash
ros2 run pub_sub pub_sub_hello_world
```

If the node is running correctly, you will see the message `Hi from pub_sub` printed to the console.

#### Create the Publisher Node

The hello world node is a simple node that prints `Hi from pub_sub` to the console.
We want to create a publisher node that publishes messages to a topic and a subscriber node that subscribes to the topic.
Writing the source code of a package from scratch is a tedious task.
Thus, it is better to start from an existing package and modify it.
In this case, we will start from the `py_pubsub` package, which is a simple publisher-subscriber example available in the `ros2` GitHub `examples` repository.

A simple, minimal publisher node is available in the `ros2` GitHub `examples` repository.
To add the publisher node to the `pub_sub` package, you must copy the source code of the publisher node to the `pub_sub` source directory.
Specifically, move into the `pub_sub_ws/src/pub_sub/pub_sub` directory and download the publisher node source code:

```bash
cd <path/to>/pub_sub_ws/src/pub_sub/pub_sub
wget https://raw.githubusercontent.com/ros2/examples/iron/rclpy/topics/minimal_publisher/examples_rclpy_minimal_publisher/publisher_member_function.py
```

There will be a new file `publisher_member_function.py` in the `pub_sub` package directory.
